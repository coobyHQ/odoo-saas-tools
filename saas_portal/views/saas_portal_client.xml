<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Client -->
    <record id="view_clients_tree" model="ir.ui.view">
        <field name="name">saas_portal.client.tree</field>
        <field name="model">saas_portal.client</field>
        <field name="priority">4</field>
        <field name="arch" type="xml">
            <tree string="Client instance" colors="red:expired" create="false" delete="false" edit="false">
                <field name="identifier"/>
                <field name="name"/>
                <field name="plan_id"/>
                <field name="client_primary_lang"/>
                <field name="state"/>
                <field name="last_connection"/>
                <field name="users_len"/>
                <field name="max_users"/>
                <field name="total_storage"/>
                <field name="total_storage_limit"/>
                <field name="trial"/>
                <field name="expiration_datetime"/>
                <field name="expired" invisible="1"/>
                <field name="login_allowed" invisible="1"/>
                <button name="%(action_edit_database)d" type="action"
                        icon="fa-sign-in" attrs="{'invisible':[('login_allowed', '=', True)]}"
                        help="Request permission from the client to log in to the database."/>
                <button name="%(action_edit_database)d" type="action"
                        icon="fa-sign-in" attrs="{'invisible':[('login_allowed', '!=', True)]}"
                        help="Log in to client database."/>
                <button type="action" name="%(saas_portal.saas_plan_change_plan_wizard_action)d"
                        icon="fa-arrow-circle-up" help="Change Plan" groups="saas_portal.saas_group_admin" states="draft,open,pending"/>
                <!-- todo seems confirm wizard does not work here !!
                <button name="delete_database_server" type="object" attrs="{'invisible':[('state', 'in', ['draft', 'deleted'])]}"
                        icon="fa-eraser" help="Delete client database" groups="saas_portal.saas_group_admin" confirm="Are you sure to delete this database?"/>
                  -->
                <button name="show_upgrade_wizard" attrs="{'invisible':[('state', 'in', ['deleted'])]}"
                        type="object" icon="fa-cogs" help="Configure client database" groups="saas_portal.saas_group_admin"/>
            </tree>
        </field>
    </record>

    <record id="view_clients_form" model="ir.ui.view">
        <field name="name">saas_portal.client.form</field>
        <field name="model">saas_portal.client</field>
        <field name="arch" type="xml">
            <form string="Clients" create="false" delete="false" edit="true">
                <field name="expired" invisible="1"/>
                <header>
                    <button string="Request Login Permission" name="%(action_edit_database)d" type="action"
                            attrs="{'invisible':[('login_allowed', '=', True)]}"
                            icon="fa-sign-in" class="oe_highlight" groups="saas_portal.saas_group_agent"
                            help="Request permission from the client to log in to the database."
                            />
                    <button string="Log in" name="%(action_edit_database)d" type="action"
                            attrs="{'invisible':[('login_allowed', '!=', True)]}"
                            icon="fa-sign-in" class="oe_highlight" groups="saas_portal.saas_group_agent"
                            help="Log in to client database."
                            />
                    <button string="Change Server" type="action" name="%(saas_portal.saas_plan_change_server_wizard_action)d"
                            groups="saas_portal.saas_group_admin" states="draft,open,pending"/>
                    <button string="Change Plan" type="action" name="%(saas_portal.saas_plan_change_plan_wizard_action)d"
                            groups="saas_portal.saas_group_admin" states="draft,open,pending"/>
                    <button name="%(saas_portal.action_rename_database)d" string="Rename Database" type="action"
                            groups="saas_portal.saas_group_admin"/>
                    <button string="Delete" name="delete_database_server" type="object"
                            attrs="{'invisible':['|',('state', 'in', ['draft', 'deleted'])]}" icon="fa-eraser"
                            groups="saas_portal.saas_group_admin" confirm="Are you sure to delete this database?"/>
                    <button string="Sync server" type="object" name="action_sync_server" icon="fa-refresh"/>
                    <button string="Sync client" type="object" name="sync_client" icon="fa-refresh"/>
                    <button string="Configure" name="show_upgrade_wizard" type="object"
                            attrs="{'invisible':[('state', 'in', ['deleted','draft'])]}" icon="fa-cogs"
                            groups="saas_portal.saas_group_admin"/>
                    <field name="state" widget="statusbar" statusbar_visible="open,pending,deleted" clickable=""/>
                </header>
                <sheet>
                     <div class="oe_button_box" name="button_box">
                       <!-- placeholder -->
                     </div>
                     <div class="oe_left" style="width: 500px;">
                        <field name="plan_image" widget="image" class="oe_avatar oe_left"/>
                        <div class="oe_title" style="width: 410px;">
                            <label class="oe_edit_only" for="name_txt" string="Name"/>
                            <h1><field name="name_txt" class="oe_inline"/></h1>
                            <label  for="subdomain" string="Subdomain / Database Name"/>
                            <h2><field name="subdomain" nolabel="1"/>.<field name="domain" class="oe_inline"/></h2>
                        </div>
                    </div>
                    <group>
                        <label for="identifier"/><field name="identifier" nolabel="1" style="font-weight:bold" colspan="4"/><br/>
                        <label for="plan_id"/><field name="plan_id"/><br/>
                        <label for="partner_id"/><field name="partner_id"/>
                    </group>
                    <field name="login_allowed" invisible="1"/>
                    <group col="2" name="limits">
                        <group string="User Limits">
                            <field name="users_len"/>
                            <!-- limits -->
                            <br></br>
                            <field name="plan_max_users"/>
                          <!--        <field name="topup_users"/> -->
                           <field name="max_users" style="font-weight:bold"/>
                        </group>
                        <group string="Storage Limits">
                            <field name="file_storage"/>
                            <field name="db_storage"/>
                            <field name="total_storage" style="font-weight:bold"/>
                            <!-- limits -->
                            <br></br>
                            <field name="plan_max_storage"/>
                            <!--   <field name="topup_storage_limit"/> -->
                            <field name="total_storage_limit" style="font-weight:bold"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="client_id" readonly="1"/>
                            <field name="server_id" readonly="1"/>
                            <field name="notification_sent"/>
                            <field name="domain"/>
                           <!-- moved <field name="support_team_id"/> -->
                        </group>
                        <group name="subscription">
                            <field name="trial"/>
                            <field name="trial_hours" attrs="{'invisible': [('trial', '!=', False)]}"/>
                            <field name="expiration_datetime"/>
                            <field name="client_primary_lang" readonly="1"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Notes" name="notes">

                            <group>
                                <field name="note" nolabel="0"/>
                            </group>
                        </page>
                        <page string="Advanced Settings" name="settings">
                            <group>
                                <field name="block_on_expiration" class="oe_inline"/>
                                <field name="block_on_storage_exceed" class="oe_inline"/>
                            </group>
                        </page>
                    </notebook>
                    </sheet>
                    <div class="oe_chatter">
                        <field name="message_follower_ids" widget="mail_followers"/>
                        <field name="activity_ids" widget="mail_activity"/>
                        <field name="message_ids" widget="mail_thread" options="{'display_log_button': True}"/>
                    </div>
            </form>
        </field>
    </record>

    <record id="view_saas_portal_client_filter" model="ir.ui.view">
        <field name="name">saas_portal.client.select</field>
        <field name="model">saas_portal.client</field>
        <field name="arch" type="xml">
            <search string="Search Client">
                <field name="name" string="Database Name"/>
                <filter string="Running" name="current" domain="[('state', '=','open')]"/>
                <separator/>
                <field name="partner_id" string="Contact" filter_domain="[('partner_id', 'child_of', self)]"/>
                <group expand="0" string="Group By">
                    <filter string="Plan" domain="[]" context="{'group_by':'plan_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_clients" model="ir.actions.act_window">
        <field name="name">Client instances</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">saas_portal.client</field>
        <field name="view_type">form</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="view_saas_portal_client_filter"/>
        <field name="context">{'search_default_current': 1}</field>
    </record>

    <menuitem name="Client Instances" action="action_clients" id="menu_clients" parent="menu_base_saas" sequence="1"/>

    <!-- Client Config -->

    <record id="action_database_form" model="ir.ui.view">
        <field name="name">action.database.form</field>
        <field name="model">saas.config</field>
        <field name="arch" type="xml">
            <form string="Configure Database" create="false" edit="false" delete="false">
                 <group>
                    <field name="id" invisible="1" />
                    <field name="action" readonly="1"/>

                 </group>
                 <notebook>
                 <page string="Result"  attrs="{'invisible': [('id', '=', False)]}">
                    <field name="description" />
                 </page>

                 <page string="Addons"  attrs="{'invisible': [('action', '!=', 'upgrade')]}">
                     <p>Comma-separated list of addons to Update, Install or Uninstall, e.g. <em>point_of_sale,website_sale</em></p>
                     <group>
                        <field name="update_addons_list"/>
                         <field name="update_addons"/>
                         <field name="install_addons"/>
                         <field name="uninstall_addons"/>
                     </group>
                 </page>
                 <page string="Parameters" attrs="{'invisible': [('action', '!=', 'upgrade')]}">
                     <field name="param_ids" colspan="4" >
                         <tree editable="bottom">
                             <field name="key" />
                             <field name="value" />
                         </tree>
                     </field>
                 </page>
                 <page string="Access rights">
                     <p>Comma-separated list of references to res.groups, e.g. <em>base.group_sale_manager,stock.group_stock_manager</em>.</p>
                     <group>
                         <field name="access_owner_add"/>
                         <field name="access_remove"/>
                     </group>
                 </page>
                 <page string="Commands" attrs="{'invisible': [('action', '!=', 'upgrade')]}">
                     <p>This sections allows execute special commands on client. Ask developers for instructions.</p>
                     <field name="fix_ids" colspan="4" >
                         <tree editable="bottom">
                             <field name="model" />
                             <field name="method" />
                         </tree>
                     </field>
                 </page>
                 <page string="Limit Number Of Records" attrs="{'invisible': [('action', '!=', 'upgrade')]}">
                   <p>This sections allows to limit number of records in arbitrary model on client. Ask developers for instructions.</p>
                   <field name="limit_line_ids" colspan="4" >
                     <tree editable="bottom">
                       <field name="model" />
                       <field name="max_records" />
                       <field name="domain" />
                     </tree>
                   </field>
                 </page>
                 <page string='Affected Database(s)'>
                    <field name="database_ids">
                        <tree>
                            <field name="name"/>
                            <field name="server_id"/>
                            <field name="plan_id"/>
                        </tree>
                    </field>
                 </page>
                 </notebook>
                 <footer>
                    <button name="execute_action" string="Execute" type="object" class="oe_highlight"/>
                    or
                    <button string="Close" class="oe_link" special="cancel"/>
                </footer>
            </form>
        </field>
    </record>

    <record id="action_upgrade_clients" model="ir.actions.act_window">
        <field name="name">Upgrade Clients</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">saas.config</field>
        <field name="view_type">form</field>
        <field name="view_mode">form</field>
        <field name="target">new</field>
        <field name="context">{'default_action': 'upgrade'}</field>
    </record>

    <!-- Configure Client Databases -->
    <act_window id="act_configure_clients"
    name="Configure Clients"
    res_model="saas.config"
    key2="client_action_multi"
    src_model="saas_portal.client"
    context="{'default_action': 'upgrade'}"
    view_mode="form" target="new" view_type="form" />

    <!--<menuitem action="action_upgrade_clients" id="menu_upgrade_clients" parent="saas_portal.menu_saas" sequence="100"/>-->

    <!-- Upgrade Databases -->
    <record id="action_updb" model="ir.actions.act_window">
        <field name="name">Configure Databases</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">saas.config</field>
        <field name="view_type">form</field>
        <field name="target">new</field>
    </record>

    <!-- Delete Client Databases -->
    <act_window id="act_delete_batch_clients"
    name="Delete Clients"
    res_model="saas_portal.batch_delete_wizard"
    key2="client_action_multi"
    src_model="saas_portal.client"
    view_mode="form" target="new" view_type="form"/>

</odoo>
